<!DOCTYPE html>
<html class="dark" lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Remind</title>
  
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#121212">
  
  <!-- Styles & Fonts -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>
  
  <script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#d4af35",
            "background-light": "#f8f7f6",
            "background-dark": "#121212",
          },
          fontFamily: {
            "display": ["Inter", "sans-serif"]
          },
          borderRadius: {
            "DEFAULT": "0.5rem",
            "lg": "1rem",
            "xl": "1.5rem",
            "full": "9999px"
          },
        },
      },
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .material-symbols-outlined {
        font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
      }
      .text-gold-subtle {
        color: #C5B358;
      }
      .border-gold-subtle {
        border-color: #C5B358;
      }
      .bg-gold-gradient {
        background-image: linear-gradient(to bottom right, #FFD700, #B8860B);
      }
      .glow-gold {
        box-shadow: 0 0 15px 5px rgba(212, 175, 53, 0.3);
      }
      .glow-shadow {
        box-shadow: 0 0 15px 0 rgba(212, 175, 53, 0.4);
      }
    }
  </style>
  
  <style>
    body {
      min-height: max(884px, 100dvh);
    }
    
    /* Custom alert styles */
    .web-alert {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      max-width: 350px;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .web-alert.hide {
      animation: slideOut 0.3s ease-in;
    }
    
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
  </style>
</head>

<body class="bg-background-dark font-display">
  <div class="relative flex min-h-screen w-full flex-col text-white">
    
    <!-- Top App Bar -->
    <header class="sticky top-0 z-10 flex items-center bg-background-dark/80 px-4 py-3 backdrop-blur-sm">
      <div class="flex size-10 items-center justify-center text-primary">
        <span class="material-symbols-outlined !text-4xl" style="font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 200, 'opsz' 40;">
          task_alt
        </span>
      </div>
      <h1 class="flex-1 text-center text-lg font-bold tracking-tight text-white/90">Daily Remind</h1>
      <div class="flex w-10 items-center justify-end">
        <p id="currentDate" class="text-gold-subtle whitespace-nowrap text-sm font-semibold"></p>
      </div>
    </header>

    <main class="flex-1 space-y-6 p-4 pb-28">
      
      <!-- Motivational Card -->
      <div class="rounded-xl border border-gold-subtle/30 bg-[#201d12] p-4">
        <div class="flex flex-col items-stretch justify-start">
          <div class="flex w-full grow flex-col items-stretch justify-center gap-2">
            <p id="motivasi" class="text-lg font-bold leading-tight tracking-tight text-white"></p>
            <div class="flex items-end justify-between gap-3">
              <p class="text-gold-subtle text-base font-normal leading-normal" id="motivasiAuthor"></p>
              <button onclick="testNotification()" class="text-xs text-primary underline hover:no-underline">
                Tes Notifikasi
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Notification Status -->
      <div id="notificationStatus" class="rounded-xl border border-gold-subtle/30 bg-[#201d12] p-4 hidden">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <span id="statusIcon" class="material-symbols-outlined text-2xl">info</span>
            <div>
              <p id="statusTitle" class="text-base font-medium text-white">Status Notifikasi</p>
              <p id="statusMessage" class="text-sm text-gray-400">Memeriksa...</p>
            </div>
          </div>
          <button onclick="requestNotificationPermission(true)" class="px-3 py-1 bg-primary text-background-dark rounded-lg text-sm font-medium">
            Aktifkan
          </button>
        </div>
      </div>

      <!-- Section Header -->
      <h2 class="px-1 pt-4 text-xl font-bold leading-tight tracking-tight text-white">Tugas Hari Ini</h2>

      <!-- Task List -->
      <div id="taskList" class="space-y-3">
        <!-- Tasks will be rendered here -->
      </div>

      <!-- Empty State -->
      <div id="emptyState" class="hidden flex-col items-center justify-center text-center p-8 mt-8">
        <div class="relative mb-6">
          <span class="material-symbols-outlined text-8xl text-primary/20">hourglass_empty</span>
          <span class="material-symbols-outlined absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-5xl text-primary">add_task</span>
        </div>
        <h3 class="text-lg font-bold text-white">Daftar Tugas Anda Kosong</h3>
        <p class="mt-2 text-sm text-gray-400">Mulai tambahkan tugas pertamamu.</p>
      </div>
    </main>

    <!-- Floating Action Button -->
    <div class="fixed bottom-6 right-6 z-20">
      <button id="addTaskBtn" class="flex h-16 w-16 items-center justify-center rounded-full bg-gold-gradient text-background-dark glow-gold transition-transform active:scale-95">
        <span class="material-symbols-outlined !text-4xl" style="font-variation-settings: 'wght' 500;">
          add
        </span>
      </button>
    </div>
  </div>

  <!-- Add/Edit Task Modal -->
  <div id="taskModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
    <div class="relative flex min-h-screen w-full flex-col bg-background-dark overflow-y-auto">
      
      <!-- Top App Bar -->
      <div class="flex items-center bg-background-dark p-4 pb-2 justify-between sticky top-0 z-10 border-b border-primary/20">
        <button id="closeModalBtn" class="text-primary flex size-12 shrink-0 items-center justify-center">
          <span class="material-symbols-outlined text-3xl">arrow_back_ios_new</span>
        </button>
        <h2 id="modalTitle" class="text-primary text-xl font-bold leading-tight tracking-[-0.015em] flex-1 text-center">Tambah Tugas</h2>
        <div class="flex size-12 shrink-0 items-center"></div>
      </div>

      <!-- Form Content -->
      <main class="flex-1 px-4 py-6 space-y-6">
        <!-- Task Title Field -->
        <label class="flex flex-col w-full">
          <p class="text-primary text-base font-medium leading-normal pb-2">Judul Tugas</p>
          <input id="taskTitle" class="flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-white focus:outline-0 focus:ring-2 focus:ring-primary/80 border border-primary/40 bg-black/20 focus:border-primary h-14 placeholder:text-gray-400 p-[15px] text-base font-normal leading-normal" placeholder="Contoh: Selesaikan laporan"/>
        </label>

        <!-- Date & Time Picker -->
        <label class="flex flex-col w-full">
          <p class="text-primary text-base font-medium leading-normal pb-2">Tanggal & Waktu</p>
          <div class="relative">
            <input id="taskTime" type="datetime-local" class="flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-white focus:outline-0 focus:ring-2 focus:ring-primary/80 border border-primary/40 bg-black/20 focus:border-primary h-14 placeholder:text-gray-400 pl-12 pr-4 py-[15px] text-base font-normal leading-normal"/>
            <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none">
              <span class="material-symbols-outlined text-primary">calendar_month</span>
            </div>
          </div>
        </label>

        <!-- Priority Selector -->
        <div>
          <h3 class="text-primary text-base font-medium leading-normal pb-3">Prioritas</h3>
          <div class="grid grid-cols-3 gap-3">
            <button id="priorityLow" class="priority-btn flex items-center justify-center rounded-lg border border-primary/40 bg-black/20 p-3 h-14 text-sm font-semibold text-white hover:bg-primary/20 transition-colors" data-priority="rendah">Rendah</button>
            <button id="priorityMedium" class="priority-btn flex items-center justify-center rounded-lg border border-primary bg-primary/30 p-3 h-14 text-sm font-semibold text-primary ring-2 ring-primary transition-colors" data-priority="sedang">Sedang</button>
            <button id="priorityHigh" class="priority-btn flex items-center justify-center rounded-lg border border-primary/40 bg-black/20 p-3 h-14 text-sm font-semibold text-white hover:bg-primary/20 transition-colors" data-priority="tinggi">Tinggi</button>
          </div>
        </div>

        <!-- Reminder Toggle -->
        <div class="flex items-center justify-between py-2">
          <p class="text-primary text-base font-medium leading-normal">Aktifkan Pengingat</p>
          <label class="relative inline-flex items-center cursor-pointer">
            <input id="reminderToggle" checked type="checkbox" class="sr-only peer">
            <div class="w-14 h-7 bg-black/20 peer-focus:outline-none rounded-full peer dark:bg-black/30 peer-checked:after:translate-x-full peer-checked:after:border-primary rtl:peer-checked:after:-translate-x-full after:content-[''] after:absolute after:top-[4px] after:start-[4px] after:bg-white dark:after:bg-gray-800 after:border-gray-300 dark:after:border-gray-600 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
          </label>
        </div>
      </main>

      <!-- Save Button -->
      <div class="sticky bottom-0 w-full p-4 bg-background-dark">
        <button id="saveTaskBtn" class="w-full h-14 flex items-center justify-center rounded-lg bg-gradient-to-r from-yellow-700 via-primary to-yellow-500 text-background-dark font-bold text-lg glow-shadow transition-transform active:scale-95">
          Simpan
        </button>
      </div>
    </div>
  </div>

  <!-- Web Alert Container -->
  <div id="webAlertContainer"></div>

  <script>
    // VARIABLES GLOBAL
    let editIndex = null;
    let currentPriority = 'sedang';
    let enableReminders = true;

    // MOTIVASI OTOMATIS
    const motivasiList = [
      { text: "Semangat! Satu tugas lagi membuatmu lebih maju!", author: "Daily Remind" },
      { text: "Ingat, masa depanmu dibangun hari ini.", author: "Daily Remind" },
      { text: "Kecilkan kemalasan, besarkan aksi!", author: "Daily Remind" },
      { text: "Sedikit demi sedikit menjadi bukit.", author: "Peribahasa" },
      { text: "Kamu mampu melewati hari ini, tetap jalan!", author: "Daily Remind" },
      { text: "Rahasia untuk maju adalah memulai.", author: "Mark Twain" },
      { text: "Satu langkah kecil hari ini, sukses besar esok hari.", author: "Daily Remind" }
    ];

    // FUNCTIONS
    function getTasks() {
      return JSON.parse(localStorage.getItem("tasks") || "[]");
    }

    function saveTasks(tasks) {
      localStorage.setItem("tasks", JSON.stringify(tasks));
    }

    // WEB ALERT SYSTEM
    function showWebAlert(title, message, type = 'info') {
      const alertContainer = document.getElementById('webAlertContainer');
      const alertId = 'alert-' + Date.now();
      
      const typeConfig = {
        info: { bg: 'bg-blue-600', icon: 'info' },
        success: { bg: 'bg-green-600', icon: 'check_circle' },
        warning: { bg: 'bg-yellow-600', icon: 'warning' },
        error: { bg: 'bg-red-600', icon: 'error' }
      };
      
      const config = typeConfig[type] || typeConfig.info;
      
      const alertHTML = `
        <div id="${alertId}" class="web-alert ${config.bg} text-white p-4 rounded-lg shadow-lg">
          <div class="flex items-center gap-3">
            <span class="material-symbols-outlined">${config.icon}</span>
            <div class="flex-1">
              <p class="font-semibold">${title}</p>
              <p class="text-sm opacity-90">${message}</p>
            </div>
            <button onclick="closeWebAlert('${alertId}')" class="text-white hover:text-gray-200">
              <span class="material-symbols-outlined">close</span>
            </button>
          </div>
        </div>
      `;
      
      alertContainer.insertAdjacentHTML('beforeend', alertHTML);
      
      // Auto remove after 5 seconds
      setTimeout(() => {
        closeWebAlert(alertId);
      }, 5000);
    }

    function closeWebAlert(alertId) {
      const alert = document.getElementById(alertId);
      if (alert) {
        alert.classList.add('hide');
        setTimeout(() => {
          alert.remove();
        }, 300);
      }
    }

    // NOTIFICATION SYSTEM - IMPROVED FOR MOBILE
    async function requestNotificationPermission(showAlert = false) {
      if (!('Notification' in window)) {
        if (showAlert) {
          showWebAlert('Tidak Didukung', 'Browser ini tidak mendukung notifikasi', 'error');
        }
        return false;
      }

      if (Notification.permission === 'granted') {
        if (showAlert) {
          showWebAlert('Berhasil', 'Notifikasi sudah diaktifkan!', 'success');
        }
        updateNotificationStatus();
        return true;
      }

      if (Notification.permission === 'denied') {
        if (showAlert) {
          showWebAlert('Izin Ditolak', 
            'Izin notifikasi ditolak. Buka pengaturan browser untuk mengaktifkannya.', 
            'error');
        }
        updateNotificationStatus();
        return false;
      }

      try {
        const permission = await Notification.requestPermission();
        const granted = permission === 'granted';
        
        if (showAlert) {
          if (granted) {
            showWebAlert('Berhasil', 'Notifikasi berhasil diaktifkan!', 'success');
            // Test notification immediately
            setTimeout(() => testNotification(), 1000);
          } else {
            showWebAlert('Dibatalkan', 'Izin notifikasi diperlukan untuk pengingat tugas', 'warning');
          }
        }
        
        updateNotificationStatus();
        return granted;
      } catch (error) {
        console.log('Error meminta izin notifikasi:', error);
        if (showAlert) {
          showWebAlert('Error', 'Gagal meminta izin notifikasi', 'error');
        }
        return false;
      }
    }

    function updateNotificationStatus() {
      const statusElement = document.getElementById('notificationStatus');
      const statusIcon = document.getElementById('statusIcon');
      const statusTitle = document.getElementById('statusTitle');
      const statusMessage = document.getElementById('statusMessage');
      
      if (!('Notification' in window)) {
        statusElement.classList.remove('hidden');
        statusIcon.textContent = 'do_not_disturb';
        statusIcon.className = 'material-symbols-outlined text-2xl text-red-500';
        statusTitle.textContent = 'Tidak Didukung';
        statusMessage.textContent = 'Browser tidak mendukung notifikasi';
        return;
      }
      
      switch(Notification.permission) {
        case 'granted':
          statusElement.classList.add('hidden');
          break;
        case 'denied':
          statusElement.classList.remove('hidden');
          statusIcon.textContent = 'block';
          statusIcon.className = 'material-symbols-outlined text-2xl text-red-500';
          statusTitle.textContent = 'Izin Ditolak';
          statusMessage.textContent = 'Akses notifikasi ditolak di pengaturan browser';
          break;
        case 'default':
          statusElement.classList.remove('hidden');
          statusIcon.textContent = 'notifications_off';
          statusIcon.className = 'material-symbols-outlined text-2xl text-yellow-500';
          statusTitle.textContent = 'Belum Diaktifkan';
          statusMessage.textContent = 'Aktifkan notifikasi untuk pengingat tugas';
          break;
      }
    }

    function showNotification(title, body) {
      // Always show web alert
      showWebAlert(title, body, 'info');
      
      // Try browser notification if permission granted
      if ('Notification' in window && Notification.permission === 'granted') {
        try {
          const options = {
            body: body,
            icon: '/icon-192.png',
            badge: '/icon-192.png',
            tag: 'daily-remind',
            requireInteraction: true,
            vibrate: [200, 100, 200] // Vibrate pattern for mobile
          };

          // For mobile devices, use service worker if available
          if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            navigator.serviceWorker.ready.then(registration => {
              registration.showNotification(title, options);
            }).catch(error => {
              // Fallback to regular notification
              new Notification(title, options);
            });
          } else {
            // Fallback for desktop and mobile without service worker
            new Notification(title, options);
          }
        } catch (error) {
          console.log('Error showing notification:', error);
          // Web alert already shown, so user still gets the message
        }
      }
    }

    function testNotification() {
      if (!('Notification' in window)) {
        showWebAlert('Tes Notifikasi', 'Browser tidak mendukung notifikasi', 'error');
        return;
      }

      if (Notification.permission !== 'granted') {
        showWebAlert('Tes Notifikasi', 
          'Harap aktifkan notifikasi terlebih dahulu', 'warning');
        requestNotificationPermission(true);
        return;
      }

      // Show test notification
      showNotification(
        'Daily Remind - Tes', 
        'Ini adalah notifikasi tes. Notifikasi berfungsi dengan baik! ðŸŽ‰'
      );
      
      showWebAlert('Tes Notifikasi', 'Notifikasi tes dikirim!', 'success');
    }

    function setPriority(priority) {
      currentPriority = priority;
      
      // Reset all buttons
      const lowBtn = document.getElementById('priorityLow');
      const mediumBtn = document.getElementById('priorityMedium');
      const highBtn = document.getElementById('priorityHigh');
      
      if (lowBtn && mediumBtn && highBtn) {
        // Remove active styles from all
        [lowBtn, mediumBtn, highBtn].forEach(btn => {
          btn.classList.remove('border-primary', 'bg-primary/30', 'ring-2', 'ring-primary', 'text-primary');
          btn.classList.add('border-primary/40', 'bg-black/20', 'text-white');
        });
        
        // Add active styles to selected
        const activeBtn = document.getElementById(`priority${priority.charAt(0).toUpperCase() + priority.slice(1)}`);
        if (activeBtn) {
          activeBtn.classList.add('border-primary', 'bg-primary/30', 'ring-2', 'ring-primary', 'text-primary');
          activeBtn.classList.remove('border-primary/40', 'bg-black/20', 'text-white');
        }
      }
    }

    function openAddModal() {
      editIndex = null;
      document.getElementById('modalTitle').textContent = 'Tambah Tugas';
      document.getElementById('taskTitle').value = '';
      
      // Set default time to next hour
      const nextHour = new Date();
      nextHour.setHours(nextHour.getHours() + 1);
      nextHour.setMinutes(0);
      document.getElementById('taskTime').value = nextHour.toISOString().slice(0, 16);
      
      setPriority('sedang');
      document.getElementById('reminderToggle').checked = true;
      enableReminders = true;
      document.getElementById('taskModal').classList.remove('hidden');
    }

    function openEditModal(index) {
      editIndex = index;
      const tasks = getTasks();
      const task = tasks[index];
      
      document.getElementById('modalTitle').textContent = 'Edit Tugas';
      document.getElementById('taskTitle').value = task.title;
      
      // Format time for datetime-local input
      let timeValue = task.time;
      if (timeValue && !timeValue.includes('T')) {
        timeValue = timeValue.replace(' ', 'T');
      }
      document.getElementById('taskTime').value = timeValue;
      
      setPriority(task.priority || 'sedang');
      document.getElementById('reminderToggle').checked = task.enableReminders !== false;
      enableReminders = task.enableReminders !== false;
      document.getElementById('taskModal').classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('taskModal').classList.add('hidden');
    }

    function saveTask() {
      const title = document.getElementById("taskTitle").value.trim();
      const time = document.getElementById("taskTime").value;

      if (!title || !time) {
        showWebAlert('Error', 'Isi semua kolom!', 'error');
        return;
      }

      const tasks = getTasks();
      
      if (editIndex === null) {
        // Add new task
        tasks.push({ 
          title, 
          time, 
          priority: currentPriority,
          notified: false,
          enableReminders: enableReminders,
          remindersSent: [],
          createdAt: new Date().toISOString()
        });
        showWebAlert('Berhasil', 'Tugas berhasil ditambahkan!', 'success');
      } else {
        // Update existing task
        tasks[editIndex] = { 
          ...tasks[editIndex],
          title, 
          time, 
          priority: currentPriority,
          enableReminders: enableReminders
        };
        showWebAlert('Berhasil', 'Tugas berhasil diperbarui!', 'success');
      }
      
      saveTasks(tasks);
      closeModal();
      renderTasks();
    }

    function deleteTask(index) {
      if (confirm("Hapus tugas ini?")) {
        const tasks = getTasks();
        tasks.splice(index, 1);
        saveTasks(tasks);
        renderTasks();
        showWebAlert('Berhasil', 'Tugas berhasil dihapus!', 'success');
      }
    }

    function toggleTask(index) {
      const tasks = getTasks();
      tasks[index].notified = !tasks[index].notified;
      saveTasks(tasks);
      renderTasks();
      
      const status = tasks[index].notified ? 'diselesaikan' : 'dibuka kembali';
      showWebAlert('Tugas Diupdate', `Tugas "${tasks[index].title}" ${status}`, 'info');
    }

    function getPriorityColor(priority) {
      switch(priority) {
        case 'tinggi': return 'text-primary';
        case 'sedang': return 'text-gold-subtle';
        case 'rendah': return 'text-gold-subtle/70';
        default: return 'text-gold-subtle';
      }
    }

    function getPriorityText(priority) {
      switch(priority) {
        case 'tinggi': return 'Prioritas Tinggi';
        case 'sedang': return 'Prioritas Sedang';
        case 'rendah': return 'Prioritas Rendah';
        default: return 'Prioritas Sedang';
      }
    }

    function formatDateTime(dateTimeString) {
      try {
        const date = new Date(dateTimeString);
        return date.toLocaleDateString('id-ID', { 
          day: 'numeric', 
          month: 'short',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (e) {
        return dateTimeString;
      }
    }

    function renderTasks() {
      const tasks = getTasks();
      const list = document.getElementById("taskList");
      const emptyState = document.getElementById("emptyState");

      if (tasks.length === 0) {
        list.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
      }

      list.classList.remove('hidden');
      emptyState.classList.add('hidden');
      
      list.innerHTML = "";

      tasks.forEach((task, index) => {
        const taskDate = new Date(task.time);
        const now = new Date();
        const isOverdue = taskDate < now && !task.notified;
        
        const taskItem = document.createElement("div");
        taskItem.className = `flex min-h-[72px] items-center justify-between gap-4 rounded-lg bg-[#201d12] p-4 ${isOverdue ? 'border border-red-500/50' : ''}`;
        
        taskItem.innerHTML = `
          <div class="flex items-center gap-4">
            <input class="task-checkbox h-5 w-5 flex-shrink-0 appearance-none rounded-md border-2 border-primary/50 bg-transparent text-primary checked:border-primary checked:bg-primary focus:outline-none focus:ring-2 focus:ring-primary/50 focus:ring-offset-2 focus:ring-offset-background-dark" type="checkbox" ${task.notified ? 'checked' : ''} data-index="${index}"/>
            <div class="flex flex-col justify-center">
              <p class="text-base font-medium leading-normal ${task.notified ? 'text-white/50 line-through' : 'text-white'}">${task.title}</p>
              <p class="text-sm font-normal leading-normal ${getPriorityColor(task.priority)}">${getPriorityText(task.priority)}</p>
              <p class="text-xs text-gray-400 mt-1">${formatDateTime(task.time)}</p>
              ${task.enableReminders === false ? '<p class="text-xs text-yellow-500 mt-1">ðŸ”• Pengingat dimatikan</p>' : ''}
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button class="edit-btn shrink-0 text-gold-subtle" data-index="${index}">
              <span class="material-symbols-outlined">edit</span>
            </button>
            <button class="delete-btn shrink-0 text-gold-subtle" data-index="${index}">
              <span class="material-symbols-outlined">delete</span>
            </button>
          </div>
        `;
        
        list.appendChild(taskItem);
      });

      // Attach event listeners to dynamically created elements
      attachEventListeners();
    }

    function attachEventListeners() {
      // Edit buttons
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.onclick = function() {
          const index = parseInt(this.getAttribute('data-index'));
          openEditModal(index);
        };
      });

      // Delete buttons
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.onclick = function() {
          const index = parseInt(this.getAttribute('data-index'));
          deleteTask(index);
        };
      });

      // Checkbox buttons
      document.querySelectorAll('.task-checkbox').forEach(checkbox => {
        checkbox.onclick = function() {
          const index = parseInt(this.getAttribute('data-index'));
          toggleTask(index);
        };
      });
    }

    function checkReminders() {
      const tasks = getTasks();
      const now = new Date().getTime();
      let needsSave = false;

      tasks.forEach((task, index) => {
        // Skip if task is completed or reminders disabled
        if (task.notified || task.enableReminders === false) return;

        const taskTime = new Date(task.time).getTime();
        const timeDiff = taskTime - now;
        
        // Define reminder intervals in milliseconds
        const intervals = {
          '3_hari': 3 * 24 * 60 * 60 * 1000,
          '1_hari': 24 * 60 * 60 * 1000,
          '12_jam': 12 * 60 * 60 * 1000,
          '3_jam': 3 * 60 * 60 * 1000,
          '1_jam': 60 * 60 * 1000,
          'tenggat': 0
        };

        // Check each reminder interval
        for (const [interval, ms] of Object.entries(intervals)) {
          if (timeDiff <= ms && timeDiff > ms - 60000) { // 1 minute window
            if (!task.remindersSent) task.remindersSent = [];
            
            if (!task.remindersSent.includes(interval)) {
              let message = '';
              switch(interval) {
                case '3_hari':
                  message = `Tugas "${task.title}" jatuh tempo dalam 3 hari!`;
                  break;
                case '1_hari':
                  message = `Tugas "${task.title}" jatuh tempo besok!`;
                  break;
                case '12_jam':
                  message = `Tugas "${task.title}" jatuh tempo dalam 12 jam!`;
                  break;
                case '3_jam':
                  message = `Tugas "${task.title}" jatuh tempo dalam 3 jam!`;
                  break;
                case '1_jam':
                  message = `Tugas "${task.title}" jatuh tempo dalam 1 jam!`;
                  break;
                case 'tenggat':
                  message = `â° WAKTUNYA! Tugas "${task.title}" sekarang jatuh tempo!`;
                  break;
              }

              showNotification('Daily Remind', message);
              
              task.remindersSent.push(interval);
              needsSave = true;

              // Mark as notified if it's the deadline
              if (interval === 'tenggat') {
                task.notified = true;
              }
            }
          }
        }
      });

      if (needsSave) {
        saveTasks(tasks);
        renderTasks();
      }
    }

    function initializeApp() {
      // Set current date
      const now = new Date();
      const options = { day: 'numeric', month: 'short' };
      document.getElementById('currentDate').textContent = now.toLocaleDateString('id-ID', options);

      // Set random motivation
      const randomMotivasi = motivasiList[Math.floor(Math.random() * motivasiList.length)];
      document.getElementById("motivasi").textContent = `"${randomMotivasi.text}"`;
      document.getElementById("motivasiAuthor").textContent = randomMotivasi.author;

      // Event listeners for static elements
      document.getElementById('addTaskBtn').onclick = openAddModal;
      document.getElementById('closeModalBtn').onclick = closeModal;
      document.getElementById('saveTaskBtn').onclick = saveTask;

      // Priority buttons
      document.querySelectorAll('.priority-btn').forEach(btn => {
        btn.onclick = function() {
          setPriority(this.getAttribute('data-priority'));
        };
      });

      // Reminder toggle
      document.getElementById('reminderToggle').onchange = function() {
        enableReminders = this.checked;
      };

      // Close modal when clicking outside
      document.getElementById('taskModal').onclick = function(e) {
        if (e.target === this) {
          closeModal();
        }
      };

      // Initial render
      renderTasks();

      // Initialize notifications
      updateNotificationStatus();

      // Check reminders every minute
      setInterval(checkReminders, 60000);

      // Also check immediately
      checkReminders();

      // REGISTER SERVICE WORKER for better mobile notifications
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("service-worker.js")
          .then(registration => {
            console.log('Service Worker terdaftar dengan sukses:', registration);
          })
          .catch(error => {
            console.log('Pendaftaran Service Worker gagal:', error);
          });
      }
    }

    // INITIALIZE APP WHEN DOCUMENT IS READY
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
  </script>
</body>
</html>